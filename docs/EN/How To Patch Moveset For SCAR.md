# How To Patch Moveset for SCAR
This tutorial would instruct you to patch your moveset to supporting the customize AI attack combos feature of SCAR.   
The tutorial would be separated into two stages：  
* **[Attack Ready Stage](https://github.com/max-su-2019/SCAR/blob/main/docs/EN/How%20To%20Patch%20Moveset%20For%20SCAR.md#attack-ready-stage)** 
* **[Attack Combos Stage](https://github.com/max-su-2019/SCAR/blob/main/docs/EN/How%20To%20Patch%20Moveset%20For%20SCAR.md#attack-combos-stage)**
   
<br/> 

## Attack Ready Stage
---  

In order to add SCAR AI data- <u>*SCAR Action Data*</u> (refer as "ActionData") for the first attack action of your moveset, You have to patch the <u>*Behavior*</u> first: creating a <u>*DummyAnimation*</u>  under the behavior‘s <u>*AttackReadyStateMachine*</u>, then using this DummyAnimation as the container to store the ActionData of the first attack animations (In ADXP, that would be "MCO_attack1.hkx" & "MCO_powerattack1.hkx"), with it SCAR could retrieves the data from SKSE plugin end.
<br/>  
Luckily, For the attack behavior of <u>*Character*</u>, SCAR already created a DummyAnimation named "SCAR_1hmReadyDummy.hkx", so you don't need to patch behavior for character yourself (still need to do for creature).   

The remaining things you need to do is annotate the ActionData of your first attack inside the "SCAR_1hmReadyDummy.hkx", then include this animation file into your moveset's DAR folder.  
<br/> 
Here is a code example of an annotation that contains an ActionData:
```
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":0, "MaxDistance":139, "StartAngle":-60, "EndAngle":60, "Chance":30, "Type":"RPA"}
```
The content of the annotation could divided into three segments, as the picture below illustrate：  

![1](../images/SCAR%20Action%20Data.jpg) 
*  `weight`: The float number `1.000000` in the leftmost originally represents the *local time* of the annotations, SCAR using it as the *weight* of the ActionData here.  
When there are multiple line of ActionData annotations inside an animation file, weight would be used to decide the priority of the ActionData, SCAR will check the anooations one by one following the descending order of the weight, that mean the ActionData with higher weight would be checking first, and the first ActionData that meet all the conditions would be perform, while the rest would be igronaed.

* `prefix text`: The "SCAR_ActionData" text segment is nothing but a prefix identifier text. It does not contains any valid data, SCAR only use it to find out the one with SCAR Action Data from the many annotations.
   
* `json data`:  The last segment that enclosed in two curly braces is a standard [json format string](https://www.w3schools.com/js/js_json_syntax.asp), stored the actual data of an SCAR Action Data:

    * `IdleAnimation` : The EditorID of the [Idle Animation](https://www.creationkit.com/index.php?title=Idle_Animations) that would be performed by the ActionData when all the conditions are meeting.  
    Idle Animation is defined by the esp plugin, *ADXP-Beta-1.31* and above version already contains two valid idle animation: "ADXP_NPCPowerAttack" and "ADXP_NPCNormalAttack" in it mco.esp, which could be used to perform powerAttack and normalAttack separately.  
    The conditions items of the idle animation would also be take into consideration when doing conditions checking.  

    *  `MaxDistance`: The maximum distance range for the ActionData to execute, only when the distance between the moveset owner to the target less than this value, the ActionData could be executed. The value of the distance must not be an negative number.  
    Be caution that you don't need to consider the weapon reach when filling the Max Distance value there, the weapon reach would be computed dynamically on SKSE plugin end.
   
    *  `MinDistance`: The minmum distance range for the ActionData to execute, only when the distance between the moveset owner to the target greater than this value, the ActionData could be executed. The value of the distance must not be an negative number.  
    MinDistance could be used to disable the performing of long distance attack when the distance to the target is close.
    
    *  `StartAngle` & `EndAngle` : These two variable are using together to generate a yaw angle range, only when the heading angle between the moveset owner to the target within this yaw angle range, the ActionData could be executed.  
    The valid value of the angle is from -180.0 to 180.0, yaw angle range is generated by drawing an arc in a clockwise direction that start at StartAngle and end at EndAngle. You can check [SampleImage1](https://raw.githubusercontent.com/max-su-2019/SCAR/main/docs/images/Scar%20Angle%20Range%2001.JPG) and [Sampleimage2](https://raw.githubusercontent.com/max-su-2019/SCAR/main/docs/images/Scar%20Angle%20Range%2002.JPG) for reference.

    * `Chance`: The random chance to execute this ActionData, the valid value is 0 to 100. 
  
    *  `Type`: The type of the action that executed by the ActionData, action type would affect the attack data and weapon reach, here are all the valid types supported by SCAR:  
    *RA - RightAttack*  
    *RPA - RightPowerAttack*  
    *LA - LeftAttack*  
    *LPA - LeftPowerAttack*  
    *DA - DualAttack*  
    *DPA - DualPowerAttack*   
    *BA - BashAttack*  
    *BPA - BashPowerAttack*  
    *IDLE - Regular Idle*   
<br/> 

Let's take the battleaxe moveset (DAR Folder 20006) of SCAR's default moveset package for example, to explain how SCAR doing it compute through the annotations.  
The SCAR related annotations inside its `SCAR_1hmReadyDummy.hkx` are as following： 
```
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":120, "MaxDistance":247, "StartAngle":-45, "EndAngle":45, "Chance":30, "Type":"RPA"}
0.500000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCNormalAttack", "MinDistance":0, "MaxDistance":48, "StartAngle":-60, "EndAngle":60, "Chance":100, "Type":"RA"}
```
The codes above contains two ActionData annotations, SCAR will check the annotation one by one by the descending order of the weight, Due to the first line of annotation has weight 1.000000, while the second line has weight 0.500000, SCAR will start from checking the conditions of the first line:
* When the distance to the combat target within the range of 120 to (247 + weapon reach), as well as the heading angle to the combat target within -45 to 45 degree, then the moveset owner would has 30% of chance to perform the "ADXP_NPCPowerAttack" Idle animation that defined in the "mco.esp", the attack action type would be *right power attack*. While under ADXP framework, that mean the moveset owner would play "mco_powerattack1.hkx" next.  

If the first ActionData above doesn't meet all the conditions, then SCAR will check for the second one in lower weight:
* When the distance to the combat target within the range of 0 to (48 + weapon reach), as well as the heading angle to the combat target within -60 to 60 degree, then the moveset owner would has 100% of chance to perform the "ADXP_NPCNormalAttack" Idle animation that defined in the "mco.esp", the attack action type would be *right attack*. While under ADXP framework, that mean the moveset owner would play "mco_attack1.hkx" next. 
  
<br/> 

### Optional Operation：  
 
1. SCAR-V0.85c and newer has added another dummy animation file named `SCAR_BlockIdleDummy.hkx` which could be used to apply SCAR Action Data when the character blocking, it works the same ways as `SCAR_1hmReadyDummy.hkx` but only active for blockIdle state.   
   
2.  SCAR-V0.85c and newer allow you to reactive the dummy animation immediately by sending an animaiton event named `SCAR_UpdateDummy`, This could help useful if you make feature that allow quick switch NPC's moveset during combat, for exmaple change the stance of an NPC.
<br/>

### CAUTION:

Do not put your dummy animation files(`SCAR_1hmReadyDummy.hkx`, `SCAR_BlockIdleDummy.hkx`) under the "meshes\actors\character\animations" path,that would trigger a CTD issue of DAR if you do so.  
Ensure that all your dummy animation files are located in DAR condtion folder("meshes\actors\character\animations\DynamicAnimationReplacer\_CustomConditions\xxxxx").

---    
<br/> <br/> 

## Attack Combos Stage
---
In order to implement SCAR attack combos for the moveset, first thing to do is adding a animation event named `SCAR_ComboStart` into the *Behavior Graph* that your attack animation belongs to.  
This animation event would be the trigger of doing SCAR Action Data checking, also as the window to fire next attack if an ActionData meet the conditions.  

Luckily, SCAR and ADXP-Beta-1.31 already added this animation event into the characer behavior graph, therefore you don't need to patch behavior yourself (still need to do for creature).  

Next step, you need to find out all the attack animation files that able to transit to next attack of the moveset, and adding SCAR Action Data annotations into the attack animation file, the same ways as you annotate ActionData in `SCAR_1hmReadyDummy.hkx`.

Moreover, you have to annotate "SCAR_ComboStart" at the local time that you want the animation to start the next attack transition.  
For ADXP, the time of "SCAR_ComboStart" should annotate between "MCO_WinOpen" to "MCO_WinClose" or between "MCO_PowerWinOpen" to "MCO_PowerWinClose". 

Below are the SCAR related annoations inside the "mco_attack1.hkx" file that belongs to the SCAR default battleaxe moveset (DAR Folder 20006):
```
1.550000 SCAR_ComboStart
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack", "MinDistance":0, "MaxDistance":29, "StartAngle":-60, "EndAngle":60, "Chance":30, "Type":"RPA"}
0.500000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCNormalAttack", "MinDistance":0, "MaxDistance":193, "StartAngle":-60, "EndAngle":60, "Chance":100, "Type":"RA"}
```
The annotations indicate that: When "mco_attack1.hkx" animation is played to 1.550000, SCAR will start checking for the ActionData annotations, and execute the ActionData that meet the conditions.  
Animation would then transit to "mco_attack2" or "mco_powerattack2" if ActionData exectue.  
<br/> 
### Optional Operation：  
You can add a suffix after the `SCAR_ComboStart` annotation to set up the total chance to trigger next attack, if you don't add the suffix the chance will be 100% by default.  
Codes Example:
```
1.550000 SCAR_ComboStart.60
```
Indicate that there has 60% chance start the next attack, 40% chance to stop the attack combos.

---
<br/> <br/> 

## Unarmed Moveset
---  
For unarmed moveset, speical handling required to be done to the ActionData annotations:  
1. If you are patching an ADXP|MCO moveset, you must use Idle animation "ADXP_NPCPowerAttack_H2H" to perform power attack and "ADXP_NPCNormalAttack_H2H" for normal attack.
2. You better assign an additional fixed `WeaponLength` value for your attack action, since the capsule length of fist is vert short in [Precision](https://www.nexusmods.com/skyrimspecialedition/mods/72347), which might cause the AI attack distance too short to start an attacking.  
   
Here is action data annotations example from the default unarmed moveset(DAR folder 20000):
```
1.000000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCPowerAttack_H2H", "MinDistance":0, "MaxDistance":80, "StartAngle":-60, "EndAngle":60, "Chance":30, "Type":"RPA", "WeaponLength":90}
0.500000 SCAR_ActionData{"IdleAnimation":"ADXP_NPCNormalAttack_H2H", "MinDistance":0, "MaxDistance":60, "StartAngle":-60, "EndAngle":60, "Chance":100, "Type":"RA", "WeaponLength":90}
```
 

---
<br/> <br/> 

## Debugging:
---
To debug your moveset in game, oepn "SKSE\Plugins\SCAR.ini", set options "EnableDebugLog" and "EnableDebugOverlay" to `true`.  
You can check the plugin log in "C:\Users\Administrator\Documents\My Games\Skyrim Special Edition\SKSE\SCAR.log".
